async function g(t,e,a){var o=await new Promise(function(s,n){try{let c="WebRTC:";switch(t.toLowerCase()){case"log":{console.log(c+" log: "+e+" : ",a);break}case"warn":{console.warn(c+" warn: "+e+" : ",a);break}case"error":{console.error(c+" error: "+e+" : ",a);break}default:{console.info(c+" info: "+e+" : ",a);break}}s("ok")}catch(c){n(c)}})}var C=class{contactPeerOptions;peerConnection;signalling;closed;uniqueID;applicationID;contactDetails;mediaRecorder;isData;fileName;fileSize;fileType;fileLastModified;fileToSend;receiveMedia;remoteStream;remoteStreamSenders;remoteStreamTransceivers;remoteStreamVideoElement;receiveDataChannel;sendDataChannel;parent;remoteTracks;sessionId;sessionIdRemote;mediaStreamTracks;eventContactPeer;constructor(t){this.contactPeerOptions=t;let e=this;this.closed=!1;let a;this.parent=t.parent,this.signalling=t.signalling,this.mediaRecorder=null,this.uniqueID=t.uniqueID,this.applicationID=t.applicationID,this.contactDetails="",this.receiveDataChannel=null,this.sendDataChannel=null;let r=[],o=0,s=0;this.isData=t.isData,this.fileName="",this.fileSize=0,this.fileType="",this.fileLastModified=0,this.fileToSend=null,this.receiveMedia=t.receiveOfferMedia,this.remoteStream=null,this.remoteStreamSenders=[],this.remoteStreamTransceivers=[],this.remoteStreamVideoElement=null,this.remoteTracks=[],this.sessionId="",this.sessionIdRemote="",this.mediaStreamTracks=[];try{this.peerConnection=new RTCPeerConnection(this.parent.config.peerConnectionConfiguration)}catch(n){g("error","Error connecting to RTCPeerConnection",n)}if(this.peerConnection){this.peerConnection.onicecandidate=function(n){let c={data:n,signalling:e.signalling};e.onIceCandidateHandler(c),e.eventContactPeer("peerContactEventICECandidate","Peer ICE candidate.",e,n)},this.peerConnection.oniceconnectionstatechange=function(n){e.eventContactPeer("peerContactEventICEStateChange","Peer ICE connection state changed.",e,n)},this.peerConnection.onicecandidateerror=function(n){e.eventContactPeer("peerContactEventICECandidateError","Peer ICE candidate error.",e,n)},this.peerConnection.onnegotiationneeded=function(n){e.eventContactPeer("peerContactEventNegotiationNeeded","Peer negotiation needed.",e,n)},this.peerConnection.onsignalingstatechange=function(n){e.eventContactPeer("peerContactEventSignalingStateChange","Peer signaling connection state changed.",e,n)},this.peerConnection.ontrack=function(n){e.eventContactPeer("peerContactEventAddStream","Peer connection stream added.",e,n)},this.peerConnection.ondatachannel=function(n){r=[],o=0,e.receiveDataChannel=n.channel,e.receiveDataChannel.binaryType="arraybuffer",e.receiveDataChannel.onmessage=function(c){r.push(c.data),o+=c.data.byteLength,e.eventContactPeer("peerContactEventDataChannelReceivedSize","Peer connection data channel received size.",e,o),o>=e.fileSize&&(e.eventContactPeer("peerContactEventDataChannelReceiveComplete","Peer connection data channel received complete.",e,r),r=[],e.receiveDataChannel.close(),e.receiveDataChannel=null)},e.receiveDataChannel.onopen=function(){if(e.receiveDataChannel){var c=e.receiveDataChannel.readyState;e.eventContactPeer("peerContactEventDataChannelOpen","Peer connection data channel open.",e,c)}},e.receiveDataChannel.onclose=function(){if(e.receiveDataChannel){var c=e.receiveDataChannel.readyState;e.eventContactPeer("peerContactEventDataChannelClose","Peer connection data channel close.",e,c)}},e.receiveDataChannel.onerror=function(c){e.eventContactPeer("peerContactEventDataChannelError","Peer connection data channel error.",e,c)}};try{e.sendDataChannel=this.peerConnection.createDataChannel("sendReceiveDataChannel_"+this.uniqueID+"_"+this.applicationID),e.sendDataChannel.binaryType="arraybuffer",e.sendDataChannel.onopen=function(){var n=e.fileToSend;if(!(!n||n.size===0)&&(s=0,e.sendDataChannel)){var c=e.sendDataChannel.readyState;e.eventContactPeer("peerContactEventDataChannelOpen","Peer connection data channel open.",e,c);var i=8096,l=function(d){var h=new FileReader;h.onload=function(u){return function(f){e.sendDataChannel.send(f.target.result),n.size>d+f.target.result.byteLength&&window.setTimeout(l,0,d+i),s=d+f.target.result.byteLength,e.eventContactPeer("peerContactEventDataChannelSentSize","Peer connection data channel sent size.",e,s),s>=n.size&&e.eventContactPeer("peerContactEventDataChannelSentComplete","Peer connection data channel sent complete.",e,!0)}}(n);var p=n.slice(d,d+i);h.readAsArrayBuffer(p)};l(0)}},e.sendDataChannel.onclose=function(){if(e.sendDataChannel){var n=e.sendDataChannel.readyState;e.eventContactPeer("peerContactEventDataChannelClose","Peer connection data channel close.",e,n)}},e.sendDataChannel.onerror=function(n){e.eventContactPeer("peerContactEventDataChannelError","Peer connection data channel error.",e,n)},e.sendDataChannel.onmessage=function(n){e.eventContactPeer("peerContactEventDataChannelSentMessage","Peer connection data channel sent message.",e,n)}}catch(n){g("error","Error creating data channel on RTCPeerConnection",n)}}}setSessionId(t){this.sessionId=t}getSessionId(){return this.sessionId}setSessionIdRemote(t){this.sessionIdRemote=t}getSessionIdRemote(){return this.sessionIdRemote}getTracks(){return this.remoteTracks}setTracks(t){this.remoteTracks=t}onContactPeerEventHandler(t){this.eventContactPeer=t}sendMessage(t){let e=this.uniqueID,a=this.applicationID;this.signalling.sendMessage(e,a,t)}sendState(t){let e=this.uniqueID,a=this.applicationID;this.signalling.sendClientState(e,a,t)}sendDetails(t){let e=this.uniqueID,a=this.applicationID;this.signalling.sendClientDetails(e,a,t)}noAnswer(){let t=this.uniqueID,e=this.applicationID;this.signalling.noAnswer(t,e)}isAvailable(){let t=this.uniqueID,e=this.applicationID;this.signalling.contactAvailable(t,e)}sendEndCall(){let t=this.uniqueID,e=this.applicationID;this.signalling.sendEndCallToContact(t,e)}setContactInfo(t,e){this.uniqueID=t,this.applicationID=e}getUniqueID(){return this.uniqueID}getApplicationID(){return this.applicationID}setContactDetails(t){this.contactDetails=t}getContactDetails(){return this.contactDetails}setRemoteStreamToVideoElement(t,e){if(e&&e.length>0){let a=this;return this.remoteStream=e[0],this.remoteStream.onremovetrack=r=>{a.eventContactPeer("peerContactEventRemoveStream","Peer connection stream removed.",a,r)},this.remoteStreamVideoElement=t,this.remoteStreamVideoElement.srcObject=this.remoteStream,!0}return!1}addTrackStreamToRemoteVideoElement(t,e){if(e){let r=this.getTracks();if(r!=null&&r.length>0&&(this.mediaStreamTracks.push(e),this.mediaStreamTracks.length==r.length)){let o=this,s=new MediaStream;for(var a=0;a<this.mediaStreamTracks.length;a++)s.addTrack(this.mediaStreamTracks[a]);return this.remoteStream=s,this.remoteStream.onremovetrack=n=>{o.eventContactPeer("peerContactEventRemoveStream","Peer connection stream removed.",o,n)},this.remoteStreamVideoElement=t,this.remoteStreamVideoElement.srcObject=this.remoteStream,!0}}return!1}setAllRemoteStreamToVideoElement(t,e){if(e&&e.length>0){let s=this.getTracks();if(s!=null&&s.length>0){for(var a=0;a<e.length;a++){let n=e[a].getTracks();for(var r=0;r<n.length;r++)this.mediaStreamTracks.push(n[r])}if(this.mediaStreamTracks.length==s.length){let n=this,c=new MediaStream;for(var o=0;o<this.mediaStreamTracks.length;o++)c.addTrack(this.mediaStreamTracks[o]);return this.remoteStream=c,this.remoteStream.onremovetrack=i=>{n.eventContactPeer("peerContactEventRemoveStream","Peer connection stream removed.",n,i)},this.remoteStreamVideoElement=t,this.remoteStreamVideoElement.srcObject=this.remoteStream,!0}}}return!1}setRemoteVideoElement(t){this.remoteStreamVideoElement=t}getStream(){return this.remoteStream}getStreamSenders(){return this.remoteStreamSenders}getStreamTransceivers(){return this.remoteStreamTransceivers}setFileInfo(t,e,a,r){this.fileName=t,this.fileSize=e,this.fileType=a,this.fileLastModified=r}close(){if(!this.closed){this.closed=!0;try{this.closeStream(),this.closeReceiveDataChannel(),this.closeSendDataChannel()}catch(e){g("error","Error closing streams",e)}this.remoteStream=null,this.remoteStreamVideoElement=null;try{for(var t=0;t<this.remoteStreamSenders.length;t++)this.peerConnection.removeTrack(this.remoteStreamSenders[t]);this.remoteStreamSenders=null,this.remoteStreamSenders=[]}catch(e){g("error","Error closing RTCRtpSender",e)}try{this.remoteStreamTransceivers=null,this.remoteStreamTransceivers=[]}catch(e){g("error","Error closing RTCRtpTransceiver",e)}try{this.remoteTracks=null,this.remoteTracks=[],this.mediaStreamTracks=null,this.mediaStreamTracks=[]}catch(e){g("error","Error closing Tracks",e)}try{this.peerConnection.close(),this.peerConnection=null}catch(e){g("error","Error closing RTCPeerConnection",e)}try{this.stopRecording()}catch(e){g("error","Error stopping recording",e)}this.eventContactPeer("peerContactEventClose","Peer connection has been closed.",this,null);try{let e=this.parent.contactPeers.indexOf(this);e>-1&&this.parent.contactPeers.splice(e,1)}catch{}}}closeMediaStreamTracks(){this.mediaStreamTracks&&(this.mediaStreamTracks=null,this.mediaStreamTracks=[])}closeReceiveDataChannel(){this.receiveDataChannel&&(this.receiveDataChannel.close(),this.receiveDataChannel=null)}closeSendDataChannel(){this.sendDataChannel&&(this.sendDataChannel.close(),this.sendDataChannel=null)}addStreamTracks(t){if(t)try{if(this.peerConnection){let e=this,a=this.peerConnection;t.getTracks().forEach(function(r){e.remoteStreamSenders.push(a.addTrack(r,t))})}}catch(e){g("error","Error adding stream tracks to RTCPeerConnection",e)}}addStreamTracksToTransceiver(t,e){if(t)try{if(this.peerConnection){let a=this,r=this.peerConnection;t.getTracks().forEach(function(o){a.remoteStreamTransceivers.push(r.addTransceiver(o,e))})}}catch(a){g("error","Error adding stream tracks to RTCPeerConnection",a)}}addTracksToTransceiver(t,e){if(t)try{if(this.peerConnection){let a=this,r=this.peerConnection;a.remoteStreamTransceivers.push(r.addTransceiver(t,e))}}catch(a){g("error","Error adding stream tracks to RTCPeerConnection",a)}}removeStreamTracks(t){if(t)try{if(this.peerConnection){let a=this.peerConnection;for(var e=0;e<t.length;e++)a.removeTrack(t[e])}}catch(a){g("error","Error removing stream tracks from RTCPeerConnection",a)}}removeStreamTransceiverTracks(){try{this.remoteStreamTransceivers=null,this.remoteStreamTransceivers=[]}catch(t){g("error","Error closing RTCRtpTransceiver",t)}}setRemoteDescription(t){this.peerConnection&&this.peerConnection.setRemoteDescription(new RTCSessionDescription(t))}setLocalDescription(t){this.peerConnection&&this.peerConnection.setLocalDescription(t)}addIceCandidate(t){this.peerConnection&&this.peerConnection.addIceCandidate(new RTCIceCandidate(t))}onIceCandidateHandler(t){let e=this.uniqueID,a=this.applicationID,r=this.isData;t.signalling.iceCandidate(e,a,t.data.candidate,r)}muteAudioVideo(t){this.peerConnection&&this.peerConnection.getSenders&&this.peerConnection.getSenders().forEach(function(e){e.track&&(e.track.enabled=!t)})}closeStream(){this.peerConnection&&this.remoteStream&&(this.remoteStream.getTracks().forEach(function(t){t.stop()}),this.remoteStreamVideoElement&&(this.remoteStreamVideoElement.srcObject=null))}startRecording(t,e){if(this.remoteStream){let a=this.remoteStream,r=this,o={mimeType:"video/webm"};try{this.mediaRecorder=new MediaRecorder(a,t)}catch(s){g("error","Error creating MediaRecorder",s)}this.mediaRecorder&&(this.mediaRecorder.onstop=function(s){r.eventContactPeer("peerContactRecordingStopped","Peer has stopped recording.",r,s)},this.mediaRecorder.ondataavailable=function(s){s.data&&s.data.size>0&&r.eventContactPeer("peerContactRecordingData","Peer has recording data.",r,s.data)},this.mediaRecorder.start(e))}}stopRecording(){this.mediaRecorder&&(this.mediaRecorder.stop(),this.mediaRecorder=null)}pauseRecording(){this.mediaRecorder&&this.mediaRecorder.pause()}resumeRecording(){this.mediaRecorder&&this.mediaRecorder.resume()}sendOfferRequest(){let t=this.uniqueID,e=this.applicationID,a=this.peerConnection,r=this.signalling,o=this.receiveMedia;this.peerConnection&&this.peerConnection.createOffer(o).then(s=>new RTCSessionDescription(s)).then(s=>a.setLocalDescription(s).then(()=>{r.sendOffer(t,e,s)}).catch(n=>{g("error","Failed to create session description",n)})).catch(s=>{g("error","Failed to create session description",s)})}sendAnswerResponse(){let t=this.uniqueID,e=this.applicationID,a=this.peerConnection,r=this.signalling;this.peerConnection&&this.peerConnection.createAnswer().then(o=>new RTCSessionDescription(o)).then(o=>a.setLocalDescription(o).then(()=>{r.sendAnswer(t,e,o)}).catch(s=>{g("error","Failed to create session description",s)})).catch(o=>{g("error","Failed to create session description",o)})}sendFileTransferOfferRequest(t){let e=this.uniqueID,a=this.applicationID,r=this.peerConnection,o=this.signalling;this.sendDataChannel&&(this.fileToSend=t),this.peerConnection&&this.peerConnection.createOffer().then(s=>new RTCSessionDescription(s)).then(s=>r.setLocalDescription(s).then(()=>{o.sendFileTransferOffer(e,a,s,t.name,t.size,t.type,t.lastModified)}).catch(n=>{g("error","Failed to create session description",n)})).catch(s=>{g("error","Failed to create session description",s)})}sendFileTransferAnswerResponse(){let t=this.uniqueID,e=this.applicationID,a=this.peerConnection,r=this.signalling;this.peerConnection&&this.peerConnection.createAnswer().then(o=>new RTCSessionDescription(o)).then(o=>a.setLocalDescription(o).then(()=>{r.sendFileTransferAnswer(t,e,o)}).catch(s=>{g("error","Failed to create session description",s)})).catch(o=>{g("error","Failed to create session description",o)})}sendJoinConferenceOfferRequest(){let t=this.uniqueID,e=this.applicationID,a=this.peerConnection,r=this.signalling,o=this.receiveMedia;this.peerConnection&&this.peerConnection.createOffer(o).then(s=>new RTCSessionDescription(s)).then(s=>a.setLocalDescription(s).then(()=>{r.sendJoinConferenceOffer(t,e,s)}).catch(n=>{g("error","Failed to create session description",n)})).catch(s=>{g("error","Failed to create session description",s)})}sendJoinConferenceAnswerResponse(){let t=this.uniqueID,e=this.applicationID,a=this.peerConnection,r=this.signalling;this.peerConnection&&this.peerConnection.createAnswer().then(o=>new RTCSessionDescription(o)).then(o=>a.setLocalDescription(o).then(()=>{r.sendJoinConferenceAnswer(t,e,o)}).catch(s=>{g("error","Failed to create session description",s)})).catch(o=>{g("error","Failed to create session description",o)})}},b=class{signalOptions;webSocket;closed;config;eventSignalling;constructor(t){this.signalOptions=t;let e=this;this.closed=!1;let a,r=t||{},o=this.config={signallingURL:"wss://127.0.0.1:443"};for(a in r)r.hasOwnProperty(a)&&(o[a]=r[a]);try{this.webSocket=new WebSocket(o.signallingURL)}catch(s){g("error","Error connecting to WebSocket",s)}this.webSocket&&(this.webSocket.onopen=function(s){e.eventSignalling("signallingEventOpen","Signalling has opened.",e,s)},this.webSocket.onerror=function(s){e.eventSignalling("signallingEventError","Signalling has encountered and unknown error.",e,s)},this.webSocket.onclose=function(s){e.eventSignalling("signallingEventClose","Signalling has closed.",e,s)},this.webSocket.onmessage=function(s){let n=null;if(n=JSON.parse(s.data),n.response)if(n.error)e.eventSignalling("signallingEventErrorDetails","Signalling has encountered an error.",e,n.error);else if(n.applications)e.eventSignalling("signallingEventApplications","Signalling has applications",e,n.applications);else if(n.uniques)e.eventSignalling("signallingEventUniques","Signalling has uniques",e,n.uniques);else if(n.groups)e.eventSignalling("signallingEventGroups","Signalling has groups",e,n.groups);else if(n.settings&&n.settings===!0)e.eventSignalling("signallingEventSettings","Signalling settings have been applied.",e,n.settings);else if(n.contactAvailable){let c=n.contactUniqueID,i=n.contactApplicationID,l={contactUniqueID:c,contactApplicationID:i,contactAvailable:n.contactAvailable};e.eventSignalling("signallingEventAvailable","Signalling contact available.",e,l)}else if(n.contactMessage){let c=n.contactUniqueID,i=n.contactApplicationID,l={contactUniqueID:c,contactApplicationID:i,contactMessage:n.contactMessage};e.eventSignalling("signallingEventMessage","Signalling contact message.",e,l)}else if(n.clientState){let c=n.contactUniqueID,i=n.contactApplicationID,l={contactUniqueID:c,contactApplicationID:i,contactState:n.state};e.eventSignalling("signallingEventState","Signalling contact state.",e,l)}else if(n.clientDetails){let c=n.contactUniqueID,i=n.contactApplicationID,l={contactUniqueID:c,contactApplicationID:i,clientDetails:n.details};e.eventSignalling("signallingEventDetails","Signalling contact details.",e,l)}else if(n.available&&n.available===!0){let c=n.contactUniqueID,i=n.contactApplicationID,l=!1;if((n.fileTransferOffer||n.fileTransferAnswer||n.isData)&&(l=!0),n.sdp){let d={contactUniqueID:c,contactApplicationID:i,sdp:n.sdp,isData:l};e.eventSignalling("signallingEventSDP","Signalling an SDP signal has been received.",e,d)}if(n.candidate){let d={contactUniqueID:c,contactApplicationID:i,candidate:n.candidate,type:n.type,isData:l};e.eventSignalling("signallingEventCandidate","Signalling a candidate signal has been received.",e,d)}if(n.callOffer){let d={contactUniqueID:c,contactApplicationID:i};e.eventSignalling("signallingEventOffer","Signalling an offer signal has been received.",e,d)}if(n.callAnswer){let d={contactUniqueID:c,contactApplicationID:i};e.eventSignalling("signallingEventAnswer","Signalling an answer signal has been received.",e,d)}if(n.joinConferenceOffer){let d={contactUniqueID:c,contactApplicationID:i,conference:n.conferenceCall};e.eventSignalling("signallingEventJoinConferenceOffer","Signalling a join conference offer signal has been received.",e,d)}if(n.joinConferenceAnswer){let d={contactUniqueID:c,contactApplicationID:i,conference:n.conferenceCall};e.eventSignalling("signallingEventJoinConferenceAnswer","Signalling a join conference answer signal has been received.",e,d)}if(n.fileTransferOffer){let d={contactUniqueID:c,contactApplicationID:i,name:n.name,size:n.size,type:n.type,lastModified:n.lastModified,fileTransfer:n.fileTransferOffer};e.eventSignalling("signallingEventFileOffer","Signalling a file transfer offer signal has been received.",e,d)}if(n.fileTransferAnswer){let d={contactUniqueID:c,contactApplicationID:i,fileTransfer:n.fileTransferAnswer};e.eventSignalling("signallingEventFileAnswer","Signalling a file answer signal has been received.",e,d)}if(n.noanswer){let d={contactUniqueID:c,contactApplicationID:i,noanswer:n.noanswer};e.eventSignalling("signallingEventNoAnswer","Signalling the peer contact did not answer.",e,d)}if(n.endCallRemote){let d={contactUniqueID:c,contactApplicationID:i,endCallRemote:n.endCallRemote};e.eventSignalling("signallingEventEndCall","Signalling the peer contact ended the call.",e,d)}if(n.contactTypingMessage){let d={contactUniqueID:c,contactApplicationID:i,contactTypingMessage:n.contactTypingMessage,typing:n.typing};n.typing&&n.typing===!0?e.eventSignalling("signallingEventTypingMessage","Signalling the contact is typing a message.",e,d):e.eventSignalling("signallingEventTypingMessage","Signalling the contact has stopped typing.",e,d)}else{let d={contactAvailable:n.available};e.eventSignalling("signallingEventSelfAvailable","Signalling the contact is available.",e,d)}}else{let c={contactAvailable:n.available};e.eventSignalling("signallingEventSelfAvailable","Signalling the contact is not available.",e,c)}else e.eventSignalling("signallingEventErrorDetails","Signalling has encountered an unknown error.",e,null)})}onSignallingEventHandler(t){this.eventSignalling=t}changeClientSettings(t,e,a,r,o,s){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({uniqueID:t,applicationID:e,available:a,broadcast:r,broadcastAppID:o,accessToken:s}))}sendClientState(t,e,a){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,clientState:!0,state:a}))}sendClientDetails(t,e,a){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,clientDetails:!0,details:a}))}sendMessage(t,e,a){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,contactMessage:a}))}iceCandidate(t,e,a,r){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,candidate:a,type:"candidate",isData:r}))}noAnswer(t,e){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,noanswer:!0}))}sendEndCallToContact(t,e){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,endCallRemote:!0}))}contactAvailable(t,e){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,contactAvailable:!0}))}sendOffer(t,e,a){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,callOffer:!0,sdp:a}))}sendAnswer(t,e,a){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,callAnswer:!0,sdp:a}))}sendJoinConferenceOffer(t,e,a){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,joinConferenceOffer:!0,conferenceCall:!0,sdp:a}))}sendJoinConferenceAnswer(t,e,a){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,joinConferenceAnswer:!0,conferenceCall:!0,sdp:a}))}startedTypingMessage(t,e){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,contactTypingMessage:!0,typing:!0}))}stoppedTypingMessage(t,e){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,contactTypingMessage:!0,typing:!1}))}sendFileTransferOffer(t,e,a,r,o,s,n){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,fileTransferOffer:!0,name:r,size:o,type:s,lastModified:n,sdp:a}))}sendFileTransferAnswer(t,e,a){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,fileTransferAnswer:!0,sdp:a}))}noFileTransferAnswer(t,e){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send(JSON.stringify({contactUniqueID:t,contactApplicationID:e,noanswer:!0}))}contactUniqueIDList(){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send("uniqueids")}contactApplicationIDList(){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send("applicationids")}contactGroupList(){this.webSocket.readyState===this.webSocket.OPEN&&this.webSocket.send("uniqueapplication")}close(){if(!this.closed&&(this.closed=!0,this.webSocket)){if(this.webSocket.readyState!==this.webSocket.OPEN)return;try{this.webSocket.close(),this.webSocket=null}catch(t){g("error","Error closing signalling",t)}}}},D=class{webRtcOptions;closed;contactPeers;signalling;config;uniqueID;applicationID;mediaRecorder;localStream;localStreamVideoElement;eventWebRtcAdapter;eventWebRtcAdapterSignalling;eventWebRtcAdapterContactPeer;constructor(t){this.webRtcOptions=t;let e=this;this.closed=!1;let a,r=t||{};this.uniqueID=t.uniqueID,this.applicationID=t.applicationID,this.contactPeers=[],this.localStream=null,this.localStreamVideoElement=null,this.mediaRecorder=null;let o=this.config={peerConnectionConfiguration:{iceServers:[{urls:"stun:stun.l.google.com:19302"}]},peerConnectionConstraints:{optional:[]},receiveOfferMedia:{offerToReceiveAudio:1,offerToReceiveVideo:1},signallingURL:"wss://127.0.0.1:443"};for(a in r)r.hasOwnProperty(a)&&(this.config[a]=r[a]);let s={signallingURL:o.signallingURL};this.signalling=new b(s),this.signalling.onSignallingEventHandler((n,c,i,l)=>{e.eventWebRtcAdapterSignalling(n,c,i,l)})}onWebRtcAdapterEventHandler(t){this.eventWebRtcAdapter=t}onContactPeerEventHandler(t){this.eventWebRtcAdapterContactPeer=t}onSignallingEventHandler(t){this.eventWebRtcAdapterSignalling=t}changeClientSettings(t,e,a,r,o,s){this.uniqueID=t,this.applicationID=e,this.signalling.changeClientSettings(t,e,a,r,o,s)}getUniqueID(){return this.uniqueID}getApplicationID(){return this.applicationID}startedTypingMessage(t,e){this.signalling.startedTypingMessage(t,e)}stoppedTypingMessage(t,e){this.signalling.stoppedTypingMessage(t,e)}contactUniqueIDList(){this.signalling.contactUniqueIDList()}contactApplicationIDList(){this.signalling.contactApplicationIDList()}contactGroupList(){this.signalling.contactGroupList()}createContactPeer(t){let e=this;t.parent=e,t.signalling=this.signalling;let a=new C(t);return a.onContactPeerEventHandler((r,o,s,n)=>{e.eventWebRtcAdapterContactPeer(r,o,s,n)}),this.contactPeers.push(a),a}removeContactPeers(){this.getContactPeers().forEach(function(t){t.close()})}removeContactPeer(t,e,a){this.getContactPeers().forEach(function(r){r.uniqueID===t&&r.applicationID===e&&r.isData===a&&r.close()})}getContactPeers(){return this.contactPeers.filter(function(t){return!0})}getContactPeer(t,e,a){return this.contactPeers.filter(function(r){return r.uniqueID===t&&r.applicationID===e&&r.isData===a})}isContactPeer(t,e){return this.contactPeers.filter(function(a){return a.uniqueID===t&&a.applicationID===e})}sendStateToAllContacts(t){this.contactPeers.forEach(function(e){e.sendState(t)})}sendMessageToAllContacts(t){this.contactPeers.forEach(function(e){e.sendMessage(t)})}sendMessageToContact(t,e,a,r){this.contactPeers.forEach(function(o){o.uniqueID===t&&o.applicationID===e&&o.isData===r&&o.sendMessage(a)})}sendDetailsToAllContacts(t){this.contactPeers.forEach(function(e){e.sendDetails(t)})}sendDetailsToContact(t,e,a,r){this.contactPeers.forEach(function(o){o.uniqueID===t&&o.applicationID===e&&o.isData===r&&o.sendDetails(a)})}sendEndCallToAllContacts(){this.contactPeers.forEach(function(t){t.sendEndCall()})}sendEndCallToContact(t,e,a){this.contactPeers.forEach(function(r){r.uniqueID===t&&r.applicationID===e&&r.isData===a&&r.sendEndCall()})}setContactFileInfo(t,e,a,r,o,s,n){this.contactPeers.forEach(function(c){c.uniqueID===t&&c.applicationID===e&&c.isData===a&&c.setFileInfo(r,o,s,n)})}isContactAvailable(t,e,a){this.contactPeers.forEach(function(r){r.uniqueID===t&&r.applicationID===e&&r.isData===a&&r.isAvailable()})}close(){if(!this.closed){this.closed=!0;try{this.closeStream(),this.localStream=null,this.localStreamVideoElement=null}catch(t){g("error","Error closing stream",t)}try{this.signalling.close(),this.signalling=null}catch(t){g("error","Error closing signalling",t)}try{this.stopRecording()}catch(t){g("error","Error stopping recording",t)}this.removeContactPeers()}}muteAudioVideo(t){this.contactPeers.forEach(function(e){e.muteAudioVideo(t)})}closeStream(){this.localStream&&(this.localStream.getTracks().forEach(function(t){t.stop()}),this.localStreamVideoElement&&(this.localStreamVideoElement.srcObject=null))}createStream(t,e){let a=this;navigator.mediaDevices.getUserMedia({audio:t,video:e}).then(function(r){a.localStream=r,a.localStreamVideoElement.srcObject=a.localStream}).catch(function(r){g("error","Error could not create stream",r)})}createStreamCapture(t){let e=this,a={video:{displaySurface:t},audio:!1};navigator.mediaDevices.getDisplayMedia(a).then(function(r){e.localStream=r,e.localStreamVideoElement.srcObject=e.localStream}).catch(function(r){g("error","Error could not create capture stream",r)})}createStreamEx(t){let e=this;navigator.mediaDevices.getUserMedia(t).then(function(a){e.localStream=a,e.localStreamVideoElement.srcObject=e.localStream}).catch(function(a){g("error","Error could not create stream",a)})}createStreamCaptureEx(t){let e=this;navigator.mediaDevices.getDisplayMedia(t).then(function(a){e.localStream=a,e.localStreamVideoElement.srcObject=e.localStream}).catch(function(a){g("error","Error could not create capture stream",a)})}setLocalStreamToVideoElement(t){return this.localStream?(this.localStreamVideoElement=t,this.localStreamVideoElement.srcObject=this.localStream,!0):!1}getAudioInputDevices(t){let e=[];navigator.mediaDevices.enumerateDevices().then(function(a){for(var r=0;r!==a.length;++r){let o=a[r];o.kind==="audioinput"&&e.push(o)}t(e)}).catch(function(a){g("error","Error could not get audio input devices",a)})}getAudioOutputDevices(t){let e=[];navigator.mediaDevices.enumerateDevices().then(function(a){for(var r=0;r!==a.length;++r){let o=a[r];o.kind==="audiooutput"&&e.push(o)}t(e)}).catch(function(a){g("error","Error could not get audio output devices",a)})}getVideoInputDevices(t){let e=[];navigator.mediaDevices.enumerateDevices().then(function(a){for(var r=0;r!==a.length;++r){let o=a[r];o.kind==="videoinput"&&e.push(o)}t(e)}).catch(function(a){g("error","Error could not get video input devices",a)})}setLocalVideoElement(t){this.localStreamVideoElement=t}getStream(){return this.localStream}setStream(t){this.localStream=t}startRecording(t,e){if(this.localStream){var a=this.localStream;try{this.mediaRecorder=new MediaRecorder(a,t)}catch(r){g("error","Error creating MediaRecorder",r)}if(this.mediaRecorder){let r=this;this.mediaRecorder.onstop=function(o){r.eventWebRtcAdapter("adapterRecordingStopped","Adapter has stopped recording.",r,o)},this.mediaRecorder.ondataavailable=function(o){o.data&&o.data.size>0&&r.eventWebRtcAdapter("adapterRecordingData","Adapter has recording data.",r,o.data)},this.mediaRecorder.start(e)}}}stopRecording(){this.mediaRecorder&&(this.mediaRecorder.stop(),this.mediaRecorder=null)}pauseRecording(){this.mediaRecorder&&this.mediaRecorder.pause()}resumeRecording(){this.mediaRecorder&&this.mediaRecorder.resume()}},E=class{webRtcOptions;webrtcadapter;closed;config;parent;eventWebRtc;constructor(t){this.webRtcOptions=t;let e=this;this.closed=!1;let a;this.parent=null;let r=t||{},o=this.config={peerConnectionConfiguration:{iceServers:[{urls:"stun:stun.l.google.com:19302"}]},peerConnectionConstraints:{optional:[]},receiveOfferMedia:{offerToReceiveAudio:1,offerToReceiveVideo:1},signallingURL:"wss://127.0.0.1:443",localVideo:{autoplay:!0,mirror:!0,muted:!0}};for(a in r)r.hasOwnProperty(a)&&(this.config[a]=r[a]);this.webrtcadapter=new D(this.config),this.webrtcadapter.onWebRtcAdapterEventHandler((s,n,c,i)=>{switch(s){case"adapterRecordingData":{let l={data:i,text:n,object:c,objectName:"WebRtcAdapter",objectEvent:i,rtc:e};e.eventWebRtc("recordingData",l);break}case"adapterRecordingStopped":{let l={evt:i,text:n,object:c,objectName:"WebRtcAdapter",objectEvent:i,rtc:e};e.eventWebRtc("recordingStopped",l);break}}}),this.webrtcadapter.onContactPeerEventHandler((s,n,c,i)=>{switch(s){case"peerContactEventICEStateChange":{let l={contact:c,state:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactICEStateChange",l);break}case"peerContactEventICECandidateError":{let l={contact:c,error:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactICECandidateError",l);break}case"peerContactEventICECandidate":{let l={contact:c,message:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactICECandidate",l);break}case"peerContactEventSignalingStateChange":{let l={contact:c,state:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactSignalingStateChange",l);break}case"peerContactEventNegotiationNeeded":{let l={contact:c,state:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactNegotiationNeeded",l);break}case"peerContactEventRemoveStream":{let l={contact:c,remove:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactRemoveStream",l);break}case"peerContactEventAddStream":{let l={contact:c,add:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactAddStream",l);break}case"peerContactEventAddTrack":{let l={contact:c,add:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactAddStream",l);break}case"peerContactEventDataChannelReceivedSize":{let l={contact:c,size:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactReceiveSize",l);break}case"peerContactEventDataChannelReceiveComplete":{let l={contact:c,buffer:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactReceiveComplete",l);break}case"peerContactEventDataChannelOpen":{let l={contact:c,open:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactReceiveOpen",l);break}case"peerContactEventDataChannelClose":{let l={contact:c,close:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactReceiveClose",l);break}case"peerContactEventDataChannelError":{let l={contact:c,error:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactReceiveError",l);break}case"peerContactEventDataChannelSentSize":{let l={contact:c,size:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactSentSize",l);break}case"peerContactEventDataChannelSentComplete":{let l={contact:c,buffer:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactSentComplete",l);break}case"peerContactEventDataChannelSentMessage":{let l={contact:c,message:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactSentMessage",l);break}case"peerContactEventClose":{let l={contact:c,session:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactClose",l);break}case"peerContactEventSessionError":{let l={contact:c,session:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactSessionError",l);break}case"peerContactRecordingData":{let l={contact:c,data:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactRecordingData",l);break}case"peerContactRecordingStopped":{let l={contact:c,evt:i,text:n,object:c,objectName:"ContactPeer",objectEvent:i,rtc:e};e.eventWebRtc("contactRecordingStopped",l);break}}}),this.webrtcadapter.onSignallingEventHandler((s,n,c,i)=>{switch(s){case"signallingEventOpen":{let l={open:!0,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("connectionOpen",l);break}case"signallingEventError":{let l={error:!0,data:i.data,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("connectionError",l);break}case"signallingEventClose":{let l={close:!0,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("connectionClose",l);break}case"signallingEventErrorDetails":{let l={error:i,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalError",l);break}case"signallingEventApplications":{let l={list:i,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalApplications",l);break}case"signallingEventUniques":{let l={list:i,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalUniques",l);break}case"signallingEventGroups":{let l={list:i,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalGroups",l);break}case"signallingEventSettings":{let l={setting:i,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalSettings",l);break}case"signallingEventAvailable":{let d={contact:e.createContact(i.contactUniqueID,i.contactApplicationID),available:i.contactAvailable,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalAvailable",d);break}case"signallingEventSelfAvailable":{let l={available:i.contactAvailable,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalSelfAvailable",l);break}case"signallingEventMessage":{let d={contact:e.createContact(i.contactUniqueID,i.contactApplicationID),message:i.contactMessage,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalMessage",d);break}case"signallingEventState":{let d={contact:e.createContact(i.contactUniqueID,i.contactApplicationID),state:i.contactState,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalState",d);break}case"signallingEventDetails":{let l=e.createContact(i.contactUniqueID,i.contactApplicationID);l.setContactDetails(i.clientDetails);let d={contact:l,details:i.clientDetails,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalDetails",d);break}case"signallingEventJoinConferenceOffer":{let d={contact:e.createContact(i.contactUniqueID,i.contactApplicationID),conference:i.conference,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalJoinConferenceOffer",d);break}case"signallingEventJoinConferenceAnswer":{let d={contact:e.createContact(i.contactUniqueID,i.contactApplicationID),conference:i.conference,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalJoinConferenceAnswer",d);break}case"signallingEventSDP":{let l=null;i.isData?l=e.createContactData(i.contactUniqueID,i.contactApplicationID):l=e.createContact(i.contactUniqueID,i.contactApplicationID);let d={contact:l,text:n,isData:i.isData,sdp:i.sdp,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalSDP",d);break}case"signallingEventCandidate":{let l=null;i.isData?l=e.createContactData(i.contactUniqueID,i.contactApplicationID):l=e.createContact(i.contactUniqueID,i.contactApplicationID);let d={contact:l,text:n,isData:i.isData,candidate:i.candidate,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalIceCandidate",d);break}case"signallingEventOffer":{let d={contact:e.createContact(i.contactUniqueID,i.contactApplicationID),text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalOffer",d);break}case"signallingEventAnswer":{let d={contact:e.createContact(i.contactUniqueID,i.contactApplicationID),text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalAnswer",d);break}case"signallingEventFileOffer":{let l=e.createContactData(i.contactUniqueID,i.contactApplicationID);l.setFileInfo(i.name,i.size,i.type,i.lastModified);let d={contact:l,name:i.name,size:i.size,type:i.type,lastModified:i.lastModified,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalFileOffer",d);break}case"signallingEventFileAnswer":{let d={contact:e.createContactData(i.contactUniqueID,i.contactApplicationID),text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalFileAnswer",d);break}case"signallingEventNoAnswer":{let d={contact:e.createContact(i.contactUniqueID,i.contactApplicationID),text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalNoAnswer",d);break}case"signallingEventEndCall":{let d={contact:e.createContact(i.contactUniqueID,i.contactApplicationID),text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalEndCall",d);break}case"signallingEventTypingMessage":{let d={contact:e.createContact(i.contactUniqueID,i.contactApplicationID),typing:i.typing,text:n,object:c,objectName:"Signalling",objectEvent:i,rtc:e};e.eventWebRtc("signalTyping",d);break}}})}onWebRtcEventHandler(t){this.eventWebRtc=t}createContact(t,e){let a=this.webrtcadapter.getContactPeer(t,e,!1);if(a[0])return a[0];var r={uniqueID:t,applicationID:e,isData:!1};return this.webrtcadapter.createContactPeer(r)}createContactData(t,e){var a=this.webrtcadapter.getContactPeer(t,e,!0);if(a[0])return a[0];var r={uniqueID:t,applicationID:e,isData:!0};return this.webrtcadapter.createContactPeer(r)}removeContact(t,e){this.webrtcadapter.getContactPeer(t,e,!1)[0]&&this.webrtcadapter.removeContactPeer(t,e,!1)}removeContactData(t,e){this.webrtcadapter.getContactPeer(t,e,!0)[0]&&this.webrtcadapter.removeContactPeer(t,e,!0)}isContactPeer(t,e){return!!this.webrtcadapter.isContactPeer(t,e)[0]}close(){if(!this.closed){this.closed=!0;try{this.webrtcadapter.close()}catch(t){g("error","Error closing the WebRTC interface",t)}}}changeClientSettings(t,e,a,r,o,s){this.webrtcadapter.changeClientSettings(t,e,a,r,o,s)}createStream(t,e){this.webrtcadapter.createStream(t,e)}createStreamSource(t,e){let a={audio:{deviceId:t?{exact:t}:void 0},video:{deviceId:e?{exact:e}:void 0}};this.webrtcadapter.createStreamEx(a)}createStreamCapture(t){this.webrtcadapter.createStreamCapture(t)}createStreamEx(t){this.webrtcadapter.createStreamEx(t)}createStreamCaptureEx(t){this.webrtcadapter.createStreamCaptureEx(t)}setLocalVideoElement(t){this.webrtcadapter.setLocalVideoElement(t)}setLocalStreamToVideoElement(t){this.webrtcadapter.setLocalStreamToVideoElement(t)}getAudioInputSources(t){let e=1,a=[];this.webrtcadapter.getAudioInputDevices(function(r){r.forEach(function(o){let s={deviceID:o.deviceId,deviceText:o.label||"microphone "+e};a.push(s),e++}),t(a)})}getAudioOutputSources(t){let e=1,a=[];this.webrtcadapter.getAudioOutputDevices(function(r){r.forEach(function(o){let s={deviceID:o.deviceId,deviceText:o.label||"speaker "+e};a.push(s),e++}),t(a)})}getVideoInputSources(t){let e=1,a=[];this.webrtcadapter.getVideoInputDevices(function(r){r.forEach(function(o){let s={deviceID:o.deviceId,deviceText:o.label||"camera "+e};a.push(s),e++}),t(a)})}attachSinkIdVideoElement(t,e){if(typeof t.sinkId<"u"){let a=this;t.setSinkId(e).then(function(){let r={data:e,text:"App has attached to Sink Id.",object:a,objectName:"WebRtcApp",rtc:a};a.eventWebRtc("attachSinkId",r)}).catch(function(r){g("error","Error assigning device ID",r)})}else g("error","Browser does not support output device selection.",null)}takePicture(t,e){let a=null,r=t.videoWidth,o=t.videoHeight,s=e.getContext("2d");return e.width=r,e.height=o,s.drawImage(t,0,0,r,o),a=e.toDataURL("image/png"),a}closeStream(){this.webrtcadapter.closeStream()}},v=class{webRtcOptions;webrtc;config;parent;constructor(t){this.webRtcOptions=t;let e=this,a;this.parent=null;let r=t||{},o=this.config={debug:!1,peerConnectionConfiguration:{iceServers:[{urls:"stun:stun.l.google.com:19302"}]},peerConnectionConstraints:{optional:[]},receiveOfferMedia:{offerToReceiveAudio:1,offerToReceiveVideo:1},signallingURL:"wss://127.0.0.1:443",localVideo:{autoplay:!0,mirror:!0,muted:!0}};for(a in r)r.hasOwnProperty(a)&&(this.config[a]=r[a]);this.webrtc=new E(this.config),this.webrtc.parent=e,this.webrtc.onWebRtcEventHandler((s,n)=>{e.config.debug&&g("info","Event: "+s,n);try{switch(s){case"connectionOpen":{e.connectionOpen(n);break}case"connectionError":{e.connectionError(n);break}case"connectionClose":{e.connectionClose(n);break}case"signalError":{e.signalError(n);break}case"signalApplications":{e.signalApplications(n);break}case"signalUniques":{e.signalUniques(n);break}case"signalGroups":{e.signalGroups(n);break}case"signalSettings":{e.signalSettings(n);break}case"signalAvailable":{e.signalAvailable(n);break}case"signalSelfAvailable":{e.signalSelfAvailable(n);break}case"signalMessage":{e.signalMessage(n);break}case"signalState":{e.signalState(n);break}case"signalDetails":{e.signalDetails(n);break}case"signalJoinConferenceOffer":{e.signalJoinConferenceOffer(n);break}case"signalJoinConferenceAnswer":{e.signalJoinConferenceAnswer(n);break}case"signalSDP":{e.signalSDP(n);break}case"signalIceCandidate":{e.signalIceCandidate(n);break}case"signalOffer":{e.signalOffer(n);break}case"signalAnswer":{e.signalAnswer(n);break}case"signalFileOffer":{e.signalFileOffer(n);break}case"signalFileAnswer":{e.signalFileAnswer(n);break}case"signalNoAnswer":{e.signalNoAnswer(n);break}case"signalEndCall":{e.signalEndCall(n);break}case"signalTyping":{e.signalTyping(n);break}case"contactICEStateChange":{e.contactICEStateChange(n);break}case"contactICECandidateError":{e.contactICECandidateError(n);break}case"contactICECandidate":{e.contactICECandidate(n);break}case"contactSignalingStateChange":{e.contactSignalingStateChange(n);break}case"contactNegotiationNeeded":{e.contactNegotiationNeeded(n);break}case"contactRemoveStream":{e.contactRemoveStream(n);break}case"contactAddStream":{e.contactAddStream(n);break}case"contactReceiveSize":{e.contactReceiveSize(n);break}case"contactReceiveComplete":{e.contactReceiveComplete(n);break}case"contactReceiveOpen":{e.contactReceiveOpen(n);break}case"contactReceiveClose":{e.contactReceiveClose(n);break}case"contactReceiveError":{e.contactReceiveError(n);break}case"contactSentSize":{e.contactSentSize(n);break}case"contactSentComplete":{e.contactSentComplete(n);break}case"contactSentMessage":{e.contactSentMessage(n);break}case"contactClose":{e.contactClose(n);break}case"contactSessionError":{e.contactSessionError(n);break}case"contactRecordingData":{e.contactRecordingData(n);break}case"contactRecordingStopped":{e.contactRecordingStopped(n);break}case"recordingData":{e.recordingData(n);break}case"recordingStopped":{e.recordingStopped(n);break}case"attachSinkId":{e.attachSinkId(n);break}}}catch(c){g("error","Error:",c)}})}connectionOpen;onConnectionOpen(t){this.connectionOpen=t}connectionError;onConnectionError(t){this.connectionError=t}connectionClose;onConnectionClose(t){this.connectionClose=t}signalError;onSignalError(t){this.signalError=t}signalApplications;onSignalApplications(t){this.signalApplications=t}signalUniques;onSignalUniques(t){this.signalUniques=t}signalGroups;onSignalGroups(t){this.signalGroups=t}signalSettings;onSignalSettings(t){this.signalSettings=t}signalAvailable;onSignalAvailable(t){this.signalAvailable=t}signalSelfAvailable;onSignalSelfAvailable(t){this.signalSelfAvailable=t}signalMessage;onSignalMessage(t){this.signalMessage=t}signalState;onSignalState(t){this.signalState=t}signalDetails;onSignalDetails(t){this.signalDetails=t}signalJoinConferenceOffer;onSignalJoinConferenceOffer(t){this.signalJoinConferenceOffer=t}signalJoinConferenceAnswer;onSignalJoinConferenceAnswer(t){this.signalJoinConferenceAnswer=t}signalSDP;onSignalSDP(t){this.signalSDP=t}signalIceCandidate;onSignalIceCandidate(t){this.signalIceCandidate=t}signalOffer;onSignalOffer(t){this.signalOffer=t}signalAnswer;onSignalAnswer(t){this.signalAnswer=t}signalFileOffer;onSignalFileOffer(t){this.signalFileOffer=t}signalFileAnswer;onSignalFileAnswer(t){this.signalFileAnswer=t}signalNoAnswer;onSignalNoAnswer(t){this.signalNoAnswer=t}signalEndCall;onSignalEndCall(t){this.signalEndCall=t}signalTyping;onSignalTyping(t){this.signalTyping=t}contactICEStateChange;onContactICEStateChange(t){this.contactICEStateChange=t}contactICECandidateError;onContactICECandidateError(t){this.contactICECandidateError=t}contactICECandidate;onContactICECandidate(t){this.contactICECandidate=t}contactSignalingStateChange;onContactSignalingStateChange(t){this.contactSignalingStateChange=t}contactNegotiationNeeded;onContactNegotiationNeeded(t){this.contactNegotiationNeeded=t}contactRemoveStream;onContactRemoveStream(t){this.contactRemoveStream=t}contactAddStream;onContactAddStream(t){this.contactAddStream=t}contactReceiveSize;onContactReceiveSize(t){this.contactReceiveSize=t}contactReceiveComplete;onContactReceiveComplete(t){this.contactReceiveComplete=t}contactReceiveOpen;onContactReceiveOpen(t){this.contactReceiveOpen=t}contactReceiveClose;onContactReceiveClose(t){this.contactReceiveClose=t}contactReceiveError;onContactReceiveError(t){this.contactReceiveError=t}contactSentSize;onContactSentSize(t){this.contactSentSize=t}contactSentComplete;onContactSentComplete(t){this.contactSentComplete=t}contactSentMessage;onContactSentMessage(t){this.contactSentMessage=t}contactClose;onContactClose(t){this.contactClose=t}contactSessionError;onContactSessionError(t){this.contactSessionError=t}contactRecordingData;onContactRecordingData(t){this.contactRecordingData=t}contactRecordingStopped;onContactRecordingStopped(t){this.contactRecordingStopped=t}recordingData;onRecordingData(t){this.recordingData=t}recordingStopped;onRecordingStopped(t){this.recordingStopped=t}attachSinkId;onAttachSinkId(t){this.attachSinkId=t}};function I(t,e,a){let r=null;try{t.accessToken!==""&&t.signallingURL!==""?r=new m(t):g("warn","Call Client Interface","Has not been initialised, access token and signalling URL do not exist.")}catch(o){g("Error","Could not start the Call Client interface",o)}if(r)try{e(r,a)}catch(o){g("Error","Could not initialise the Call Client interface",o)}else g("warn","Call Client Interface","Has not been initialised")}function w(t){if(t)try{t.webRtcImp.webrtc.close()}catch(e){g("Error","Could not stop the Call Client interface",e)}else g("warn","Call Client Interface","Has not been initialised")}var m=class{callOptions;config;baseURL;sessionId;remoteTracks;webRtcImp;constructor(t){this.callOptions=t;let e=this,a,r=t||{},o=this.config={debug:!1,accessToken:"",serviceBaseURL:"https://127.0.0.1/awsapi/api/cf/call/",peerConnectionConfiguration:{iceServers:[{urls:"stun:stun.cloudflare.com:3478"}],bundlePolicy:"max-bundle"},peerConnectionConstraints:{optional:[]},receiveOfferMedia:{offerToReceiveAudio:1,offerToReceiveVideo:1},signallingURL:"wss://127.0.0.1:443",localVideo:{autoplay:!0,mirror:!0,muted:!0}};for(a in r)r.hasOwnProperty(a)&&(this.config[a]=r[a]);this.sessionId="",this.remoteTracks=[],this.baseURL=this.config.serviceBaseURL+"sessions/";try{this.webRtcImp=new v(this.config),this.webRtcImp.parent=e}catch(s){g("Error","Could not start the WebRTC interface",s)}}setSessionId(t){this.sessionId=t}getSessionId(){return this.sessionId}getTracksRemote(){return this.remoteTracks}getTransceiverTracksLocal(t,e){return this.webRtcImp.webrtc.webrtcadapter.getContactPeer(t,e,!1)[0].getStreamTransceivers()}async initContactRemote(t,e,a,r){let o=!1,s={error:null,response:null,valid:o},n=!1;try{let i=this.webRtcImp.webrtc.webrtcadapter.getContactPeer(t,e,!1)[0];i.setTracks(a),i.setSessionIdRemote(r.sessionID),r.hasAudioTracks&&i.addTracksToTransceiver("audio",{direction:"inactive"}),r.hasVideoTracks&&i.addTracksToTransceiver("video",{direction:"inactive"}),await i.peerConnection.setLocalDescription(await i.peerConnection.createOffer());let{validresult:l,sessionID:d,info:h}=await this.newSessionLocal(t,e,i.peerConnection.localDescription);if(o=l,h={error:h.error,response:d,valid:o},o&&(n=!1,await new Promise((p,u)=>{i.peerConnection.addEventListener("iceconnectionstatechange",f=>{f.target.iceConnectionState==="connected"&&(n=!0,p(!0)),setTimeout(u,5e3,"connect timeout")})}),n)){n=!1,await i.peerConnection.setLocalDescription(await i.peerConnection.createOffer());let{result:p,info:u}=await this.addTrackRemote(d,t,e,a);u={error:u.error,response:d,valid:p},n=p,n&&(p=n)}}catch(c){o=!1,s={error:c,response:null,valid:o}}finally{s&&s.error&&g("Error","Failed to initialise the remote contact",s)}return{result:o,info:s}}async initContactLocal(t,e,a){let r=!1,o={error:null,response:null,valid:r},s=!1;try{let c=this.webRtcImp.webrtc.webrtcadapter.getContactPeer(t,e,!1)[0];if(c.addStreamTracksToTransceiver(a,{direction:"sendonly"}),this.getTransceiverTracksLocal(t,e).length>0){await c.peerConnection.setLocalDescription(await c.peerConnection.createOffer());let{validresult:i,sessionID:l,info:d}=await this.newSessionLocal(t,e,c.peerConnection.localDescription);if(r=i,d={error:d.error,response:l,valid:r},r&&(s=!1,await new Promise((h,p)=>{c.peerConnection.addEventListener("iceconnectionstatechange",u=>{u.target.iceConnectionState==="connected"&&(s=!0,h(!0)),setTimeout(p,5e3,"connect timeout")})}),s)){s=!1,await c.peerConnection.setLocalDescription(await c.peerConnection.createOffer());let{result:h,info:p}=await this.addTrackLocal(l,t,e,c.peerConnection.localDescription,this.getTransceiverTracksLocal(t,e));if(p={error:p.error,response:l,valid:h},s=h,s){let f=this.getTransceiverTracksLocal(t,e).map(S=>({location:"local",mid:S.mid,trackName:S.sender.track.id}));c.setTracks(f),this.remoteTracks=f.map(S=>({location:"remote",mid:S.mid,sessionId:l,trackName:S.trackName})),this.sessionId=l,h=s}}}}catch(n){r=!1,o={error:n,response:null,valid:r}}finally{o&&o.error&&g("Error","Failed to initialise the remote contact",o)}return{result:r,info:o}}async newSessionLocal(t,e,a){let r=!1,o={error:null,response:null,valid:r},s="";try{let c=this.webRtcImp.webrtc.webrtcadapter.getContactPeer(t,e,!1)[0],i={sessionDescription:{type:"offer",sdp:a.sdp}},{valid:l,newSessionResponse:d,error:h}=await this.serviceCreateNewSession(i);r=l,o={error:h,response:d,valid:r},l&&(s=d.sessionId,c.setSessionId(d.sessionId),c.setRemoteDescription(new RTCSessionDescription(d.sessionDescription)))}catch(n){r=!1,o={error:n,response:null,valid:r}}finally{o&&o.error&&g("Error","Failed to initialise the remote contact",o)}return{validresult:r,sessionID:s,info:o}}async sessionInformation(t){let e=!1,a={error:null,response:null,valid:e},r=null;try{let o={},{valid:s,getSessionInformationResponse:n,error:c}=await this.serviceGetSessionInformation(t,o);e=s,a={error:c,response:n,valid:e}}catch(o){e=!1,a={error:o,response:null,valid:e}}finally{a&&a.error&&g("Error","Failed to initialise the remote contact",a)}return{result:e,response:r,info:a}}async addTrackLocal(t,e,a,r,o){let s=!1,n={error:null,response:null,valid:s};try{let i=this.webRtcImp.webrtc.webrtcadapter.getContactPeer(e,a,!1)[0],l=o.map(f=>({location:"local",mid:f.mid,trackName:f.sender.track.id}));i.setTracks(l);let d={sessionDescription:{type:"offer",sdp:r.sdp},tracks:l},{valid:h,newTrackResponse:p,error:u}=await this.serviceAddNewTrack(t,d);s=h,n={error:u,response:p,valid:s},h&&i.setRemoteDescription(new RTCSessionDescription(p.sessionDescription))}catch(c){s=!1,n={error:c,response:null,valid:s}}finally{n&&n.error&&g("Error","Failed to initialise the remote contact",n)}return{result:s,info:n}}async addTrackRemote(t,e,a,r){let o=!1,s={error:null,response:null,valid:o};try{let c=this.webRtcImp.webrtc.webrtcadapter.getContactPeer(e,a,!1)[0];c.setTracks(r);let i={tracks:r},{valid:l,newTrackResponse:d,error:h}=await this.serviceAddNewTrack(t,i);if(o=l,s={error:h,response:d,valid:o},l&&d.requiresImmediateRenegotiation)switch(d.sessionDescription.type){case"offer":await c.setRemoteDescription(new RTCSessionDescription(d.sessionDescription)),await c.peerConnection.setLocalDescription(await c.peerConnection.createAnswer());let{result:p,info:u}=await this.renegotiateSession(t,c.peerConnection.localDescription),f=u;if(!p)throw new Error("Unable to renegotiate session. "+f.error);break;case"answer":throw new Error("An offer SDP was expected")}}catch(n){o=!1,s={error:n,response:null,valid:o}}finally{s&&s.error&&g("Error","Failed to initialise the remote contact",s)}return{result:o,info:s}}async closeTrack(t,e,a,r,o){let s=!1,n={error:null,response:null,valid:s};try{let i=this.webRtcImp.webrtc.webrtcadapter.getContactPeer(e,a,!1)[0],l=r.map(f=>({mid:f.mid})),d={force:!1,sessionDescription:{type:"offer",sdp:o.sdp},tracks:l},{valid:h,closeTrackResponse:p,error:u}=await this.serviceCloseTrack(t,d);s=h,n={error:u,response:p,valid:s},h&&i.removeStreamTransceiverTracks()}catch(c){s=!1,n={error:c,response:null,valid:s}}finally{n&&n.error&&g("Error","Failed to initialise the remote contact",n)}return{result:s,info:n}}async renegotiateSession(t,e){let a=!1,r={error:null,response:null,valid:a};try{let o={sessionDescription:{type:"answer",sdp:e.sdp}},{valid:s,renegotiateSessionResponse:n,error:c}=await this.serviceRenegotiateSession(t,o);a=s,r={error:c,response:n,valid:a}}catch(o){a=!1,r={error:o,response:null,valid:a}}finally{r&&r.error&&g("Error","Failed to initialise the remote contact",r)}return{result:a,info:r}}async serviceCreateNewSession(t){let e=!1,a=null,r=null;try{let o=this,s={method:"POST",headers:{"Content-type":"application/json",Authorization:"Bearer "+this.config.accessToken},body:JSON.stringify(t)};const n=new Promise(async(c,i)=>{try{this.jsonRequest(this.baseURL+"new",s,l=>{c(l)},l=>{i(l)})}catch(l){i(l)}});await Promise.all([n]).then(c=>{e=c[0].valid,a=c[0].error,r=c[0].result}).catch(c=>{e=!1,a=c})}catch(o){e=!1,a=o,g("Service Error","Failed to create new session",o)}finally{}return{valid:e,newSessionResponse:r,error:a}}async serviceAddNewTrack(t,e){let a=!1,r=null,o=null;try{let s=this,n={method:"POST",headers:{"Content-type":"application/json",Authorization:"Bearer "+this.config.accessToken},body:JSON.stringify(e)};const c=new Promise(async(i,l)=>{try{this.jsonRequest(this.baseURL+"add/"+t,n,d=>{i(d)},d=>{l(d)})}catch(d){l(d)}});await Promise.all([c]).then(i=>{a=i[0].valid,r=i[0].error,o=i[0].result}).catch(i=>{a=!1,r=i})}catch(s){a=!1,r=s,g("Service Error","Failed to add new track",s)}finally{}return{valid:a,newTrackResponse:o,error:r}}async serviceRenegotiateSession(t,e){let a=!1,r=null,o=null;try{let s=this,n={method:"PUT",headers:{"Content-type":"application/json",Authorization:"Bearer "+this.config.accessToken},body:JSON.stringify(e)};const c=new Promise(async(i,l)=>{try{this.jsonRequest(this.baseURL+"reneg/"+t,n,d=>{i(d)},d=>{l(d)})}catch(d){l(d)}});await Promise.all([c]).then(i=>{a=i[0].valid,r=i[0].error,o=i[0].result}).catch(i=>{a=!1,r=i})}catch(s){a=!1,r=s,g("Service Error","Failed to renegotiate session",s)}finally{}return{valid:a,renegotiateSessionResponse:o,error:r}}async serviceCloseTrack(t,e){let a=!1,r=null,o=null;try{let s=this,n={method:"PUT",headers:{"Content-type":"application/json",Authorization:"Bearer "+this.config.accessToken},body:JSON.stringify(e)};const c=new Promise(async(i,l)=>{try{this.jsonRequest(this.baseURL+"close/"+t,n,d=>{i(d)},d=>{l(d)})}catch(d){l(d)}});await Promise.all([c]).then(i=>{a=i[0].valid,r=i[0].error,o=i[0].result}).catch(i=>{a=!1,r=i})}catch(s){a=!1,r=s,g("Service Error","Failed to close track",s)}finally{}return{valid:a,closeTrackResponse:o,error:r}}async serviceGetSessionInformation(t,e){let a=!1,r=null,o=null;try{let s=this,n={method:"GET",headers:{"Content-type":"application/json",Authorization:"Bearer "+this.config.accessToken}};const c=new Promise(async(i,l)=>{try{this.jsonRequest(this.baseURL+"info/"+t,n,d=>{i(d)},d=>{l(d)})}catch(d){l(d)}});await Promise.all([c]).then(i=>{a=i[0].valid,r=i[0].error,o=i[0].result}).catch(i=>{a=!1,r=i})}catch(s){a=!1,r=s,g("Service Error","Failed to get session information",s)}finally{}return{valid:a,getSessionInformationResponse:o,error:r}}jsonRequest(t,e,a,r){fetch(t,e).then(this.responseAction).then(this.jsonResponse).then(a).catch(r)}jsonResponse(t){return t.json()}responseAction(t){return t.status>=200&&t.status<300?Promise.resolve(t):Promise.reject(new Error(t.statusText))}};export{m as CallClient,I as startCallClient,w as stopCallClient};
